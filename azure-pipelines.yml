trigger:
  branches:
    include:
    - develop
    - main
    exclude:
    - feature/*
  paths:
    include:
    - CharonDataProcessor/**
    - CharonDataProcessor/azure-pipelines.yml

pool:
  vmImage: 'ubuntu-latest'
  
variables:
  solution: 'CharonDataProcessor/src/CharonDataProcessor.sln'
  buildPlatform: 'Any CPU'
  buildConfiguration: 'Release'
  dotnetVersion: '9.0.x'
  sqlServerConnection: 'Server=localhost,1433;Database=CharonTest;User Id=sa;Password=YourStrong@Passw0rd;TrustServerCertificate=True;'

jobs:
- job: Build
  displayName: 'Build and Test'
  steps:
  - task: UseDotNet@2
    displayName: 'Use .NET SDK'
    inputs:
      packageType: 'sdk'
      version: '$(dotnetVersion)'
      installationPath: $(Agent.ToolsDirectory)/dotnet

  - task: DotNetCoreCLI@2
    displayName: 'Restore dependencies'
    inputs:
      command: 'restore'
      projects: '$(solution)'
      feedsToUse: 'select'
      includeNuGetOrg: true

  - task: DotNetCoreCLI@2
    displayName: 'Build solution'
    inputs:
      command: 'build'
      projects: '$(solution)'
      arguments: '--configuration $(buildConfiguration) --no-restore'

  - task: DotNetCoreCLI@2
    displayName: 'Run unit tests'
    inputs:
      command: 'test'
      projects: 'CharonDataProcessor/src/CharonDataProcessor.Tests/CharonDataProcessor.Tests.csproj'
      arguments: '--configuration $(buildConfiguration) --no-build --logger "trx;LogFileName=test-results.trx"'
      publishTestResults: true
      testResultsFormat: 'VSTest'
      testResultsFiles: '**/test-results.trx'

  - task: Bash@3
    displayName: 'Install SQL Server tools'
    inputs:
      targetType: 'inline'
      script: |
        curl https://packages.microsoft.com/keys/microsoft.asc | sudo apt-key add -
        curl https://packages.microsoft.com/config/ubuntu/20.04/prod.list | sudo tee /etc/apt/sources.list.d/mssql-release.list
        sudo apt-get update
        sudo ACCEPT_EULA=Y apt-get install -y mssql-tools unixodbc-dev
        echo 'export PATH="$PATH:/opt/mssql-tools/bin"' >> $GITHUB_ENV

  - task: Bash@3
    displayName: 'Wait for SQL Server'
    inputs:
      targetType: 'inline'
      script: |
        echo "Waiting for SQL Server to be ready..."
        for i in {1..30}; do
          if /opt/mssql-tools/bin/sqlcmd -S localhost,1433 -U sa -P YourStrong@Passw0rd -Q "SELECT 1" -C 2>/dev/null; then
            echo "SQL Server is ready"
            break
          fi
          echo "Waiting for SQL Server... ($i/30)"
          sleep 2
        done

  - task: Bash@3
    displayName: 'Install EF Core tools'
    inputs:
      targetType: 'inline'
      script: |
        dotnet tool install --global dotnet-ef || dotnet tool update --global dotnet-ef

  - task: Bash@3
    displayName: 'Apply database migrations'
    inputs:
      targetType: 'inline'
      workingDirectory: 'CharonDataProcessor/src'
      script: |
        dotnet ef database update --project CharonDataProcessor/CharonDataProcessor.csproj --connection "$(sqlServerConnection)" --verbose
    env:
      ConnectionStrings__DefaultConnection: '$(sqlServerConnection)'

  - task: DotNetCoreCLI@2
    displayName: 'Run integration tests'
    inputs:
      command: 'test'
      projects: 'CharonDataProcessor/src/CharonDataProcessor.IntegrationTests/CharonDataProcessor.IntegrationTests.csproj'
      arguments: '--configuration $(buildConfiguration) --no-build --logger "trx;LogFileName=integration-test-results.trx"'
      env:
        RABBITMQ_HOSTNAME: 'localhost'
        RABBITMQ_PORT: '5672'
        RABBITMQ_USERNAME: 'guest'
        RABBITMQ_PASSWORD: 'guest'
        ConnectionStrings__DefaultConnection: '$(sqlServerConnection)'
      publishTestResults: true
      testResultsFormat: 'VSTest'
      testResultsFiles: '**/integration-test-results.trx'

  - task: DotNetCoreCLI@2
    displayName: 'Publish Artifact'
    inputs:
      command: 'publish'
      projects: 'CharonDataProcessor/src/CharonDataProcessor/CharonDataProcessor.csproj'
      arguments: '--configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory)/CharonDataProcessor'
      zipAfterPublish: true

  - task: PublishBuildArtifacts@1
    displayName: 'Publish Build Artifact'
    inputs:
      pathtoPublish: '$(Build.ArtifactStagingDirectory)'
      artifactName: 'charondataprocessor-drop'
      publishLocation: 'Container'

- job: DockerBuild
  displayName: 'Build Docker Image'
  dependsOn: Build
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
  steps:
  - task: Docker@2
    displayName: 'Build Docker image'
    inputs:
      containerRegistry: 'DockerHub'
      repository: 'charondataprocessor'
      command: 'build'
      Dockerfile: 'CharonDataProcessor/src/Dockerfile'
      buildContext: '.'
      tags: |
        latest
        $(Build.BuildId)

- job: Deploy
  displayName: 'Deploy to Azure App Service'
  dependsOn: DockerBuild
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
  steps:
  - task: AzureRmWebAppDeployment@4
    displayName: 'Azure App Service Deploy'
    inputs:
      ConnectionType: 'AzureRM'
      azureSubscription: 'azure-Dev'
      appType: 'webAppLinux'
      WebAppName: 'charondataprocessor'
      packageForLinux: '$(Build.ArtifactStagingDirectory)/CharonDataProcessor/*.zip'

